<abp-modal [(visible)]="isModalOpen">
    <ng-template #abpHeader>
        <h3>{{ isEditMode ? 'Editar Evento' : 'Novo Evento' }}</h3>
    </ng-template>

    <ng-template #abpBody>
        <form [formGroup]="form" (ngSubmit)="save()">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="event-title" class="form-label">{{ '::Title' | abpLocalization }} *</label>
                    <input type="text" id="event-title" class="form-control" formControlName="title" autofocus />
                    <div *ngIf="form.get('title')?.invalid && form.get('title')?.touched"
                        class="invalid-feedback d-block">
                        <span *ngIf="form.get('title')?.errors?.['required']">{{ '::ThisFieldIsRequired' |
                            abpLocalization
                            }}</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="event-type" class="form-label">{{ '::Type' | abpLocalization }} *</label>
                    <select id="event-type" class="form-select" formControlName="type">
                        <option [ngValue]="null">{{ '::PleaseSelect' | abpLocalization }}</option>
                        <option *ngFor="let type of eventTypes" [ngValue]="type.key">
                            {{ type.value | abpLocalization }}
                        </option>
                    </select>
                    <div *ngIf="form.get('type')?.invalid && form.get('type')?.touched"
                        class="invalid-feedback d-block">
                        <span *ngIf="form.get('type')?.errors?.['required']">{{ '::ThisFieldIsRequired' |
                            abpLocalization }}</span>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="event-duration" class="form-label">{{ '::Duration' | abpLocalization }} (min) *</label>
                    <input type="number" id="event-duration" class="form-control" formControlName="durationInMinutes"
                        min="30" step="30" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="event-date" class="form-label">{{ '::Date' | abpLocalization }} *</label>
                    <input class="form-control" placeholder="YYYY-MM-DD" name="dp" formControlName="startDate"
                        ngbDatepicker #d="ngbDatepicker" (click)="d.toggle()" />
                </div>

                <div class="col-md-6 mb-3">
                    <label for="event-time" class="form-label">{{ '::Time' | abpLocalization }} *</label>
                    <ngb-timepicker formControlName="startTime" [spinners]="false"></ngb-timepicker>
                </div>
            </div>

            <!-- Relationships -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="event-artist" class="form-label">{{ '::Artist' | abpLocalization }} *</label>
                    <select id="event-artist" class="form-select" formControlName="artistId">
                        <option [ngValue]="null">{{ '::PleaseSelect' | abpLocalization }}</option>
                        <option *ngFor="let artist of artists" [ngValue]="artist.id">
                            {{ artist.name }}
                        </option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="event-client" class="form-label">{{ '::Client' | abpLocalization }} *</label>
                    <ng-select [items]="clients" bindLabel="name" bindValue="id" [searchable]="true" [clearable]="true"
                        [addTag]="onAddClient" [searchFn]="customSearchFnClient"
                        [placeholder]="'::SearchOrCreateClient' | abpLocalization" formControlName="clientId">
                        <ng-template ng-option-tmp let-item="item">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-user me-2 text-muted"></i>
                                <div>
                                    <div class="fw-bold">{{ item.name }}</div>
                                    <small class="text-muted">{{ item.email || item.phone || 'Sem contato' }}</small>
                                </div>
                            </div>
                        </ng-template>
                    </ng-select>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="event-local-partner" class="form-label">{{ '::LocalPartner' | abpLocalization }}</label>
                    <ng-select [items]="clients" bindLabel="name" bindValue="id" [searchable]="true" [clearable]="true"
                        [searchFn]="customSearchFnClient" [placeholder]="'::SelectPartner' | abpLocalization"
                        formControlName="localPartnerId">
                    </ng-select>
                </div>
            </div>

            <!-- Location Row (Full Width) -->
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="event-location" class="form-label">{{ '::Location' | abpLocalization }}</label>
                    <ng-select [items]="locations" bindLabel="name" bindValue="id" [searchable]="true"
                        [clearable]="true" [addTag]="onAddLocation" [searchFn]="customSearchFn"
                        placeholder="Buscar ou criar local..." formControlName="locationId">
                        <ng-template ng-option-tmp let-item="item">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-map-marker-alt me-2 text-muted"></i>
                                <div>
                                    <div class="fw-bold">{{ item.name }}</div>
                                    <small class="text-muted">{{ item.city }}/{{ item.state }}</small>
                                </div>
                            </div>
                        </ng-template>
                    </ng-select>
                </div>
            </div>

            <hr>

            <!-- Financial - General -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="event-status" class="form-label">{{ '::Status' | abpLocalization }}</label>
                    <select id="event-status" class="form-select" formControlName="status">
                        <option *ngFor="let status of eventStatuses" [ngValue]="status.key">
                            {{ status.value | abpLocalization }}
                        </option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="event-contract-type" class="form-label">{{ '::ContractType' | abpLocalization }}</label>
                    <select id="event-contract-type" class="form-select" formControlName="contractType">
                        <option *ngFor="let ct of contractTypes" [ngValue]="ct.key">
                            {{ ct.value | abpLocalization }}
                        </option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="event-fee" class="form-label">{{ '::Fee' | abpLocalization }}</label>
                    <input type="text" id="event-fee" class="form-control" formControlName="fee" placeholder="R$ 0,00"
                        currencyBrlInput>
                </div>
            </div>

            <!-- Financial - Production -->
            <div class="card mb-3 bg-light">
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="has-production"
                            formControlName="hasProduction">
                        <label class="form-check-label fw-bold" for="has-production">
                            {{ '::HasProduction' | abpLocalization }}
                        </label>
                    </div>

                    <div class="row" *ngIf="form.get('hasProduction')?.value">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::ProductionValue' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="productionValue"
                                placeholder="R$ 0,00" currencyBrlInput>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::ProductionPercentage' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="productionPercentage"
                                placeholder="0,00%" percentageInput>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial - Negotiation -->
            <div class="card mb-3 border-info">
                <div class="card-header bg-info text-white">{{ '::NegotiationConfig' | abpLocalization }}</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::NegotiationType' | abpLocalization }}</label>
                            <select class="form-select" formControlName="negotiationType">
                                <option *ngFor="let nt of negotiationTypes" [ngValue]="nt.key">
                                    {{ nt.value | abpLocalization }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::GuaranteeValue' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="guaranteeValue"
                                placeholder="R$ 0,00" currencyBrlInput>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::TicketPercentage' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="ticketPercentage"
                                placeholder="0,00%" percentageInput>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::DiscountValue' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="discountValue"
                                placeholder="R$ 0,00" currencyBrlInput>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial - Taxes and Commissions -->
            <div class="card mb-3 border-warning">
                <div class="card-header bg-warning">{{ '::TaxesAndCommissions' | abpLocalization }}</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::TaxPercentage' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="taxPercentage" placeholder="0,00%"
                                percentageInput>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ '::TaxValue' | abpLocalization }}</label>
                            <input type="text" class="form-control" formControlName="taxValue" placeholder="R$ 0,00"
                                currencyBrlInput>
                        </div>
                    </div>

                    <h6>{{ '::InternalCommissions' | abpLocalization }}</h6>
                    <div formArrayName="commissions">
                        <div *ngFor="let comm of commissions.controls; let i=index" [formGroupName]="i"
                            class="border p-2 mb-3 rounded bg-white shadow-sm position-relative">
                            <button type="button" class="btn btn-sm btn-link text-danger position-absolute top-0 end-0"
                                (click)="removeCommission(i)" title="Remover">
                                <i class="fa fa-times-circle"></i>
                            </button>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <label class="small fw-bold mb-1">{{ '::Description' | abpLocalization }}</label>
                                    <input type="text" class="form-control form-control-sm"
                                        formControlName="description" placeholder="Ex: Secretaria">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="small fw-bold mb-1">{{ '::Value' | abpLocalization }}</label>
                                    <input type="text" class="form-control form-control-sm" formControlName="value"
                                        placeholder="R$ 0,00" currencyBrlInput>
                                </div>
                                <div class="col-6">
                                    <label class="small fw-bold mb-1">%</label>
                                    <input type="text" class="form-control form-control-sm" formControlName="percentage"
                                        placeholder="0,00%" percentageInput>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" (click)="addCommission()">
                        <i class="fa fa-plus me-1"></i> Adicionar Comiss√£o
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label for="event-description" class="form-label">{{ '::Description' | abpLocalization }}</label>
                <textarea id="event-description" class="form-control" formControlName="description" rows="3"></textarea>
            </div>
        </form>
    </ng-template>

    <ng-template #abpFooter>
        <button type="button" class="btn btn-secondary" (click)="isModalOpen = false">
            {{ '::Cancel' | abpLocalization }}
        </button>
        <button class="btn btn-primary" type="button" [disabled]="form.invalid" (click)="save()">
            <i class="fa fa-check me-1"></i>
            {{ '::Save' | abpLocalization }}
        </button>
    </ng-template>
</abp-modal>